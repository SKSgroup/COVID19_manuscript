# Multimer CD8 Bayesian model analysis

This subdirectory contains code and data for Bayesian modeling of epitope-specific CD8 T-cell responses measured by pHLA multimer assays.

## Workflow

1. Process raw Excel files into processed analysis tables and Stan input data
2. Fit a mixed-effects logistic regression model in Stan
3. Compute posterior APCs (average predictive comparisons; &Delta;p = p_severe - p_mild)
4. Generate two manuscript figures

## Get the code

This analysis is part of the main manuscript repository. Clone the full repository, then work in this subdirectory.
```bash
git clone https://github.com/SKSgroup/COVID19_manuscript.git
cd COVID19_manuscript/multimer_cd8_bayes_model
```

Then open `multimer_cd8_bayes_model.Rproj` in RStudio (recommended).  
If not using RStudio, set the working directory to `multimer_cd8_bayes_model/` before running scripts.

## Directory structure

| Path | Contents |
|------|----------|
| `code/R/` | Numbered R scripts (setup, processing, fitting, posterior processing, figures) |
| `code/Stan/` | Stan model code |
| `data/raw/` | Raw Excel input files |
| `data/processed/` | Processed `.rds` objects generated by `01` |
| `results/` | Stan outputs and posterior summary objects generated by `02` and `03` |
| `figures/` | Figure PDFs generated by `04` and `05` |

## Run scripts in order *(interactive use recommended)*

### `00_setup_packages.R`
Install required R packages and CmdStanR/CmdStan.

### `01_process_raw_data.R`
Read raw Excel files and create processed `.rds` objects, including `standata.rds` and `index_map.rds`.

### `02_run_stan_model.R`
Compile and run the Stan model; writes CmdStan CSV chain files and saves `results/stanfit.rds`.

> **Note:** This step is computationally expensive (~11–12 hours on the author's MacBook Pro M3 Max using 4 cores).

### `03_compute_delta_p_from_posterior_draws.R`
Compute posterior APCs (&Delta;p) for peptides, HLA alleles, and peptide–HLA pairs; saves:
- `results/pep_post.rds`
- `results/hla_post.rds`
- `results/pair_post.rds`

### `04_create_peptide_hla_pair_figure.R`
Create and save:
- `figures/peptide_hla_25pairs_13pos_7neg_pseudolog.pdf`

### `05_create_hla_figure.R`
Create and save:
- `figures/hla_pseudolog.pdf`
