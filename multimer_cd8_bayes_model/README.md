# Multimer CD8 Bayesian model analysis

This subdirectory contains code and data for Bayesian modeling of epitope-specific CD8 T-cell responses measured by pHLA multimer assays.

The workflow includes:

1. processing Excel input files into Stan input data,
2. fitting a mixed-effects logistic regression model in Stan,
3. computing posterior APCs (average predictive comparisons; &Delta;p = p_severe − p_mild),
4. generating two figures included in the manuscript.

## Directory structure

- `code/R/`  
  Numbered R scripts for setup, data processing, model fitting, posterior processing, and figure generation.

- `code/Stan/`  
  Stan model code.

- `data/raw/`  
  Raw input files (Excel).

- `data/processed/`  
  Processed intermediate `.rds` objects and Stan input data (`standata.rds`) generated by `01_process_raw_data.R`.

- `results/`  
  Stan fit outputs and posterior summary objects (`*_post.rds`) generated by `02` and `03`.

- `figures/`  
  Generated figure PDFs from `04` and `05`.

## Running the code (RStudio project / working directory)

This subdirectory contains an RStudio project file: `multimer_cd8_bayes_model.Rproj`.

**Recommended workflow:** open `multimer_cd8_bayes_model.Rproj` in RStudio and run the numbered scripts from there.

This ensures the working directory is the root of this subdirectory (`multimer_cd8_bayes_model/`), so relative paths such as:

- `data/raw/...`
- `data/processed/...`
- `results/...`
- `figures/...`
- `code/Stan/...`

resolve correctly.

If you are not using RStudio, manually set the working directory to `multimer_cd8_bayes_model/` before running the scripts.

## Script order (interactive use recommended)

The scripts are intended to be run in order. Running interactively is recommended so the user can inspect printed intermediate objects and check outputs after each step.

### `00_setup_packages.R`
Installs required R packages and CmdStanR/CmdStan (if needed).

### `01_process_raw_data.R`
Reads raw Excel files and creates processed intermediate objects, including:
- `df_cov.rds`
- `df_counts.rds`
- `df_model.rds`
- `df_samp.rds`
- `standata.rds`
- `index_map.rds`

This script prints intermediate data frames/objects for inspection and includes optional sanity checks.

### `02_run_stan_model.R`
Compiles and runs the Stan model using `standata.rds`, writes CmdStan CSV chain files to `results/`, and saves a fitted model object (`stanfit.rds`).

**Note:** This step is computationally expensive (approximately 11–12 hours on a MacBook Pro M3 Max using 4 cores in the author’s setup).

### `03_compute_delta_p_from_posterior_draws.R`
Loads the fitted Stan model and computes posterior average predictive comparisons (&Delta;p) for:
- peptides
- HLA alleles
- peptide–HLA pairs

Saves:
- `results/pep_post.rds`
- `results/hla_post.rds`
- `results/pair_post.rds`

### `04_create_peptide_hla_pair_figure.R`
Generates the peptide–HLA pair posterior interval figure and saves:
- `figures/peptide_hla_25pairs_13pos_7neg_pseudolog.pdf`

### `05_create_hla_figure.R`
Generates the HLA-level posterior interval figure and saves:
- `figures/hla_pseudolog.pdf`
